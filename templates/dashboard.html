{% extends 'base.html' %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
    <h1 class="h2">Dashboard</h1>
</div>

<h3>Welcome, {{name}}</h3>
<!-- Quick Stats / Overview -->
<div class="row mb-4 mt-3">
    <!-- Completed Tasks -->
    <div class="col-12 col-sm-6 col-md-6 col-lg-3 mb-3">
        <a href="#" class="text-decoration-none">
            <div class="card text-white shadow-sm" style="background-color: #56b44a;">
                <div class="card-body d-flex align-items-center">
                    <i data-feather="check-circle" class="me-3" style="width:24px; height:24px;"></i>
                    <div>
                        <h6 class="card-title mb-0">Completed Tasks</h6>
                        <h4 class="mb-0">{{ completed_count }}</h4>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Due Today -->
    <div class="col-12 col-sm-6 col-md-6 col-lg-3 mb-3">
        <a href="#" class="text-decoration-none">
            <div class="card text-white shadow-sm" style="background-color:#e8b83f">
                <div class="card-body d-flex align-items-center">
                    <i data-feather="calendar" class="me-3" style="width:24px; height:24px;"></i>
                    <div>
                        <h6 class="card-title mb-0">Due Today</h6>
                        <h4 class="mb-0">{{ due_today_count }}</h4>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Pending Tasks -->
    <div class="col-12 col-sm-6 col-md-6 col-lg-3 mb-3">
        <a href="#" class="text-decoration-none">
            <div class="card text-white shadow-sm" style="background-color:#5387c7">
                <div class="card-body d-flex align-items-center">
                    <i data-feather="clock" class="me-3" style="width:24px; height:24px;"></i>
                    <div>
                        <h6 class="card-title mb-0">Pending Tasks</h6>
                        <h4 class="mb-0">{{ pending_count }}</h4>
                    </div>
                </div>
            </div>
        </a>
    </div>

    <!-- Overdue -->
    <div class="col-12 col-sm-6 col-md-6 col-lg-3 mb-3">
        <a href="#" class="text-decoration-none">
            <div class="card text-white shadow-sm" style="background-color:#d45b5b;">
                <div class="card-body d-flex align-items-center">
                    <i data-feather="alert-triangle" class="me-3" style="width:24px; height:24px;"></i>
                    <div>
                        <h6 class="card-title mb-0">Overdue</h6>
                        <h4 class="mb-0">{{ overdue_count }}</h4>
                    </div>
                </div>
            </div>
        </a>
    </div>
</div>

<div class="card mt-4 shadow-sm">
    <div class="card-header">
        <h5 class="mb-0">üìå Tasks Due Today</h5>
    </div>
    <div class="card-body">
        <ul class="list-group list-group-flush">
            {% for task in due_today_tasks %}
            <li class="list-group-item d-flex align-items-center">
                <form method="POST" action="{{ url_for('toggle_task_status', task_id=task.id) }}" class="me-2 d-inline-flex align-items-center">
                    <input class="form-check-input me-2" type="checkbox" name="completed" onchange="this.form.submit()" {% if task.completed %}checked{% endif %}>
                    <span>{{ task.title }}</span>
                </form>
                {% if task.due_date_obj and task.due_date_obj < current_date %}
                <span class="text-danger ms-2">‚ö†Ô∏è overdue</span>
                {% endif %}
            </li>
            {% endfor %}
        </ul>
    </div>
</div>

<div class="row mt-4">
    <!-- Calendar Card -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">üìÖ Calendar</h5>
            </div>
            <div class="card-body">
                <div id="miniCalendar" class="calendar-container shadow-sm rounded p-2 bg-light"></div>

                    <style>
                    .calendar-container {
                      max-width: 100%;
                      border: 1px solid #ddd;
                      border-radius: 12px;
                      background: #fff;
                      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
                      padding: 10px;
                      font-size: 0.9rem;
                    }

                    .fc-toolbar-title {
                      font-size: 1rem !important;
                      font-weight: 600;
                      color: #333;
                    }

                    .fc .fc-button {
                      border: none !important;
                      color: #fff !important;
                      padding: 4px 8px;
                      font-size: 0.75rem;
                      border-radius: 6px;
                    }

                    .fc-daygrid-day {
                      font-size: 0.8rem;
                    }

                    .fc-day-today {
                      background: #e6f2ff !important;
                      font-weight: bold;
                      border: 1px solid #007bff !important;
                    }
                    </style>
            </div>
        </div>
    </div>

    <!-- Pie Chart Card -->
    <div class="col-md-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h5 class="mb-0">üìä Task Progress</h5>
            </div>
            <div class="card-body">
                <canvas id="taskPieChart" style="max-height: 250px;"></canvas>
            </div>
        </div>
    </div>
</div>

<div class="card mt-4 shadow-sm">
    <div class="card-header">
        <h5 class="mb-0">‚ö° Quick Add</h5>
    </div>
    <div class="card-body">
        <form method="POST" action="{{ url_for('dashboard') }}" class="d-flex">
            <input type="text" class="form-control me-2" name="new_task" placeholder="Add a new task." required>
            <button type="submit" class="btn btn-primary">+</button>
        </form>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/main.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function() {
    // --- Pie Chart ---
    const ctx = document.getElementById('taskPieChart').getContext('2d');
    const chartData = JSON.parse(`{{ [completed_count, pending_count, overdue_count] | tojson | safe }}`);
    
    new Chart(ctx, {
        type: 'pie',
        data: {
            labels: ['Completed', 'Pending', 'Overdue'],
            datasets: [{
                data: chartData,
                backgroundColor: ['#28a745', '#ffc107', '#dc3545'],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            plugins: { legend: { position: 'bottom' } }
        }
    });

    // --- Calendar ---
    const calendarEl = document.getElementById('miniCalendar');
    if (calendarEl) {
        const calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            height: 250,
            headerToolbar: {
                left: 'prev,next today',
                center: 'title',
                right: ''
            },
            events: JSON.parse(`{{ calendar_events | tojson | safe }}`)
        });
        calendar.render();
    }
});
</script>

{% endblock %}